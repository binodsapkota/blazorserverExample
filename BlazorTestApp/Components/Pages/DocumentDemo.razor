@page "/document-demo"
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@rendermode InteractiveServer


<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">

    <MudText Typo="Typo.h4" Class="mb-4">Document Demo</MudText>

    <!-- Upload Area -->
    <MudPaper Class="pa-4 mb-4" Style="border:2px dashed #ccc; text-align:center;">
        <MudText Typo="Typo.subtitle1">Drag & Drop files here or click Upload</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Upload" Class="mt-2" OnClick="@TriggerFileUpload">
            Upload Files
        </MudButton>
        <InputFile @ref="_fileUpload" id="fileUpload" OnChange="HandleFiles" multiple style="display:none" />
        <MudProgressLinear Value="@UploadProgress" Color="Color.Primary" Class="my-2" />
    </MudPaper>

    <!-- Files Table -->
    <MudTable Items="@Files" Dense="true" Hover="true" Bordered="true">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Type</MudTh>
            <MudTh>Size (KB)</MudTh>
            <MudTh>Version</MudTh>
            <MudTh>Updated By</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.FileName</MudTd>
            <MudTd>@context.FileType</MudTd>
            <MudTd>@(context.Size / 1024)</MudTd>
            <MudTd>@(context.Versions?.Count ?? 0)</MudTd>
            <MudTd>@context.UpdatedBy</MudTd>
            <MudTd>
                <MudButton Size="Size.Small" Color="Color.Primary" Variant="Variant.Text">Download</MudButton>
                <MudButton Size="Size.Small" Color="Color.Secondary" Variant="Variant.Text" OnClick="@(() => ShowPreview(context))">Preview</MudButton>
                <MudButton Size="Size.Small" Color="Color.Info" Variant="Variant.Text">Replace</MudButton>
                <MudButton Size="Size.Small" Color="Color.Error" Variant="Variant.Text">Delete</MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>

</MudContainer>

<!-- Preview Dialog -->
<MudDialog @bind-IsVisible="_previewDialogVisible" MaxWidth="MaxWidth.Large">
    <DialogContent>
        @if (_previewType == "image")
        {
            <img src="@_previewDataUrl" style="max-width:100%; max-height:70vh;" />
        }
        else if (_previewType == "pdf")
        {
            <iframe src="@_previewDataUrl" width="100%" height="600px"></iframe>
        }
        else if (_previewType == "text")
        {
            <pre>@_previewContent</pre>
        }
        else
        {
            <MudText>Preview not available</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="() => _previewDialogVisible = false">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<DocumentFile> Files = new();
    private double UploadProgress = 0;
    private InputFile _fileUpload;

    // Preview
    private bool _previewDialogVisible = false;
    private string _previewType;
    private string _previewDataUrl;
    private string _previewContent;

    protected override void OnInitialized()
    {
        // Placeholder files for demo
        Files = new List<DocumentFile>
        {
            new DocumentFile { FileName="Sample1.pdf", FileType="application/pdf", Size=204800, Versions=new List<DocumentVersion>{ new DocumentVersion { VersionNumber=1 } }, UpdatedBy="Alice" },
            new DocumentFile { FileName="Image1.png", FileType="image/png", Size=102400, Versions=new List<DocumentVersion>{ new DocumentVersion { VersionNumber=1 } }, UpdatedBy="Bob" },
            new DocumentFile { FileName="Data.json", FileType="application/json", Size=51200, Versions=new List<DocumentVersion>{ new DocumentVersion { VersionNumber=1 } }, UpdatedBy="Charlie" }
        };
    }

    private void TriggerFileUpload()
    {
        JS.InvokeVoidAsync("triggerInputFileClick", "fileUpload");
    }

    private async Task HandleFiles(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            Files.Add(new DocumentFile
                {
                    FileName = file.Name,
                    FileType = file.ContentType,
                    Size = file.Size,
                    Versions = new List<DocumentVersion> { new DocumentVersion { VersionNumber = 1 } },
                    UpdatedBy = "DemoUser"
                });
        }

        UploadProgress = 100;
        await Task.Delay(500);
        UploadProgress = 0;
    }

    private void ShowPreview(DocumentFile file)
    {
        // Stub preview based on file type
        var ext = Path.GetExtension(file.FileName).ToLower();
        if (ext is ".png" or ".jpg" or ".jpeg" or ".gif")
        {
            _previewType = "image";
            _previewDataUrl = $"https://via.placeholder.com/600x400?text={file.FileName}";
        }
        else if (ext == ".pdf")
        {
            _previewType = "pdf";
            _previewDataUrl = $"https://example.com/{file.FileName}";
        }
        else
        {
            _previewType = "text";
            _previewContent = $"This is a demo preview of {file.FileName}";
        }

        _previewDialogVisible = true;
    }

    public class DocumentFile
    {
        public string FileName { get; set; }
        public string FileType { get; set; }
        public long Size { get; set; }
        public List<DocumentVersion> Versions { get; set; }
        public string UpdatedBy { get; set; }
    }

    public class DocumentVersion
    {
        public int VersionNumber { get; set; }
    }
}

<script>
    window.triggerInputFileClick = (inputId) => {
        document.getElementById(inputId).click();
    };
</script>